<html>
<head>
    <title>Editor Panes</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="lib/codemirror.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="jquery-resizable.js" ></script>
    

    <script>
        window.chrome.webview.addEventListener('message',
            event => handle_events(event));
    </script>
    
    <style>

        html,
        body {
            height: 100%;
            font-family: 'Trebuchet MS', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida Sans', Arial, sans-serif;
            padding: 0;
            margin: 0;
            background-color: #7F8E99;
            background-image: url("woven.png");
            overflow: auto;
        }

        .textarea {
            width: 100%;
            height: 100%;
        }

        .CodeMirror-line-numbers {
            width: 2.2em;
            color: #aaa;
            background-color: #eee;
            text-align: right;
            padding-right: .3em;
            font-size: 10pt;
            font-family: monospace;
            padding-top: .4em;
            line-height: normal;
        }

        .codemirror {
            width: 99%;
            height: 99%;
            background-color: #F5F6E4;
            box-shadow: 4px 4px 3px grey;
        }

        .page-container {
            margin: 2px;
            height: 97%;
        }

        body {
            background: rgba(178, 193, 204, 0.226);
        }

        /* horizontal panel*/

        .panel-container {
            display: flex;
            flex-direction: row;
            overflow: auto;
            width: 98%;
            height: 98%;
        }

        .panel-left {
            flex: 0 0 auto;
            /* only manually resize */
            padding: 2px;
            width: 50%;
            min-height: 100px;
            white-space: nowrap;
            color: white;
        }

        .splitter {
            flex: 0 0 auto;
            width: 6px;
            overflow: hidden;
            cursor: col-resize;
            padding: 3px;
        }

        .panel-right {
            flex: 1 1 auto;
            padding: 2px;
            min-height: 100px;
            color: white;
        }

        .panel-top-right {
            flex: 1 1 auto;
            padding: 2px;
  
            color: white;
            width: 100%;
            height: 98%;
            overflow: hidden;
            box-shadow: 4px 4px 3px grey;
        }

    


        /* vertical panel */

        .panel-container-vertical {
            display: flex;
            flex-direction: column;
            height: 95%;
            overflow: hidden;
        }

        .panel-top {
            flex: 0 0 auto;
            padding-left: 12px;
            padding-right: 12px;
            padding-bottom: 2px;
            padding-top: 2px;
            min-height: 100px;
            height: 60%;
            width: 98%;
            white-space: nowrap;
            color: white;
        }

        .splitter-horizontal {
            flex: 0 0 auto;
            height: 8px;
            cursor: row-resize;
        }

        .panel-bottom {
            flex: 1 1 auto;
            padding-left: 12px;
            padding-right: 4px;
            padding-bottom: 2px;
            padding-top: 2px;
            height: 30%;
            width: 100%;
        }

        textarea {
            width: 100%;
            height: 100%
        }

        .textarea {
            min-height: 4rem;
            overflow: auto;
        }

        .container img {
            width: 100%;
        }

        #canvas {
            margin: 20px;
            padding: 20px;
            background: #ffffff;
            border: thin inset #aaaaaa;
            width: 600px;
            height: 300px;
        }
    </style>

   
</head>

<body onload="pageloaded()">
    <div class="page-container">
        <div class="btn-group" style="margin-left: 12px;">

            <button class="btn btn-light btn-sm">

                <a href="https://www.scheme.com/tspl4/" target="_blank">
                    <i class="fa fa-book" aria-hidden="true"
                       style="color: #5c809e"></i>
                </a>
            </button>
            <button class="btn btn-light btn-sm">

                <a href="#" onclick='evaluateexpression();return false;'>
                    <i class="fa fa-play" aria-hidden="true"
                       style="color: #5c809e"></i>
                </a>
            </button>
            <button class="btn btn-light btn-sm">

                <a href="#" onclick='refreshpage();return false;'>
                    <i class="fa fa-refresh" aria-hidden="true"
                       style="color: #5c809e"></i>
                </a>
            </button>
            <button class="btn btn-light btn-sm">
                <a href="Editor.html">
                    <i aria-hidden="true"
                       style="color: #5c809e">Text</i>
                </a>
            </button>
        </div>



        <div class="bg-image">
            <div class="panel-container-vertical">
              
                <div class="panel-top">
                    <div class="panel-container">
                        <div class="panel-left">
                            <textarea id='expression'></textarea>
                        </div>
                        <div class="splitter">
                        </div>
                        <div class="panel-top-right">
                            <canvas id="image" style="width: 100%; height:100%;" ></canvas>
                        </div>
                    </div>
                </div>
                <div class="splitter-horizontal">
                </div>
                <div class="panel-bottom">
                    <div class="panel-container">
                        <div class="panel-left">
                            <textarea id='result'></textarea>
                        </div>
                        <div class="splitter">
                        </div>
                        <div class="panel-right">
                            <textarea id='transcript' width='100%'></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    

</body>
</html>
<script>
    $(".panel-left").resizable({
        handleSelector: ".splitter",
        resizeHeight: false
    });
    $(".panel-top").resizable({
        handleSelector: ".splitter-horizontal",
        resizeWidth: false
    });
</script>

<script src="lib/codemirror.js"></script>
<script src="addon/edit/closebrackets.js"></script>
<script src="addon/edit/matchbrackets.js"></script>
<script src="mode/scheme/scheme.js"></script>
<script>

    // editor application script

    function reqTranscriptListener() {
        if (this.responseText == "timed_out:busy") {
            transcript_editor.setValue(
                localStorage.getItem("lastTranscript"));
        } else {
            transcript_editor.setValue(this.responseText);
            localStorage.setItem("lastTranscript", this.responseText);
        }
    }

    function reqExpressionsListener() {
        transcript_editor.setValue(this.responseText);
    }

    function refreshOnexpressionsSaved() {
        localStorage.setItem("lastExpression",
            expression_editor.getValue());
        localStorage.setItem("lastTranscript",
            transcript_editor.getValue());
        window.location.reload(true);
    }


    // save and reload.
    function refreshpage() {
        refreshOnexpressionsSaved()
    }

    function clearepressions() {
        window.chrome.webview.postMessage('::api:3');
    }

    function cleartranscript() {
        window.chrome.webview.postMessage('::api:2');
    }

    function clearresults() {
        result_editor.setValue('');
    }

    function getexpressions() {
        expression_editor.setValue(
            localStorage.getItem("lastExpression"));
    }

    function gettranscript() {
        window.chrome.webview.postMessage('::api:1');
    }

    // not used 
    function reqExpressionListener() {
        result_editor.setValue(this.responseText);
        gettranscript();
    }

    function evaluateexpression() {
        var text = expression_editor.getValue();
        result_editor.setValue('');
        window.chrome.webview.postMessage('::eval:' + text);
        localStorage.setItem("lastExpression", text);
    }

    function reqFormatListener() {
        text = this.responseText;
        if (text == ';; error response') {
            result_editor.setValue("Re-Formatted Bad.");
        } else {
            result_editor.setValue("Re-Formatted Ok.");
            expression_editor.setValue(this.responseText);
        }
    }

    function formatexpression() {
        var text = expression_editor.getValue();
        window.chrome.webview.postMessage('::api:5' + text);
    }

    function reqExpressionListener() {
        result_editor.setValue(this.responseText);
        gettranscript();
    }

    function evaluateselectedexpression() {
        var text = expression_editor.getSelection();
        window.chrome.webview.postMessage('::eval:' + text);
        localStorage.setItem("lastExpression", text);
    }

    // access to draw on image.
    var canvas;
    var ctx;

    function pageloaded() {
        getexpressions();
        gettranscript();
        canvas = document.getElementById("image");
        ctx =canvas.getContext("2d");
        ctx.fillStyle = 'white';
        ctx.fillRect(0,0,10000,10000);

    }

    // view-source:https://codemirror.net/1/contrib/scheme/
    function addClass(element, className) {
        if (!editor.win.hasClass(element, className)) {
            element.className = ((element.className.split(" ")).concat([className])).join(" ");
        }
    }
    function removeClass(element, className) {
        if (editor.win.hasClass(element, className)) {
            var classes = element.className.split(" ");
            for (var i = classes.length - 1; i >= 0; i--) {
                if (classes[i] === className) {
                    classes.splice(i, 1);
                }
            }
            element.className = classes.join(" ");
        }
    }
    var expression_editor = CodeMirror.fromTextArea(expression, {
        lineNumbers: true, mode: "scheme",
        autoMatchParens: true,
        matchBrackets: true,
        disableSpellcheck: true,
        lineNumbers: true,
        extraKeys: {
            "Ctrl-L": function (cm) {
                clearepressions();
            },
            "Alt-F": function (cm) {
                formatexpression();
            },
            "Ctrl-Enter": function (cm) {
                evaluateexpression();
            },
            "Shift-Enter": function (cm) {
                evaluateselectedexpression();
            },
        },
        markParen: function (span, good) { addClass(span, good ? "good-matching-paren" : "bad-matching-paren"); },
        unmarkParen: function (span) { removeClass(span, "good-matching-paren"); removeClass(span, "bad-matching-paren"); }
    });
    var result_editor = CodeMirror.fromTextArea(result, {
        lineNumbers: true, mode: "scheme",
        autoMatchParens: true,
        disableSpellcheck: true,
        extraKeys: {
            "Ctrl-L": function (cm) {
                clearresults();
            },
        }
    });
    var transcript_editor = CodeMirror.fromTextArea(transcript, {
        disableSpellcheck: true,
        lineNumbers: true,
        extraKeys: {
            "Ctrl-L": function (cm) {
                cleartranscript();
            },
        }
    });

    // unlike a normal web client we have a direct message channel
    // 
    function handle_events(event) {

        var text = event.data;

        // evaluator
        var eval_reply = "::eval_reply:";
        if (text.indexOf(eval_reply) !== -1) {
            console.log("eval reply", event);
            result_editor.setValue(text.slice(eval_reply.length));
            gettranscript();
        }

        // api calls.
        var api_reply = "::api_reply:";
        if (text.indexOf(api_reply) !== -1) {
            console.log("api reply", event);


            // api 1 get transcript text response
            if (text.indexOf(":1:") !== -1) {
                transcript_editor.setValue(text.slice(api_reply.length + 2));
            }

            // api 2 clear transcript response 
            if (text.indexOf(":2:") !== -1) {
                localStorage.setItem("lastTranscript", '');
                transcript_editor.setValue('');
            }

            // api 3 clear expression response 
            if (text.indexOf(":3:") !== -1) {
                localStorage.setItem("lastExpression", '');
                expression_editor.setValue('');
            }


            // api 5 format text response
            if (text.indexOf(":5:") !== -1) {
                response = text.slice(api_reply.length + 2);
                if (response == ';; error response') {
                    result_editor.setValue("Re-Formatted Bad.");
                } else {
                    result_editor.setValue("Re-Formatted Ok.");
                    expression_editor.setValue(response);
                }
            }
        }

        if (text.indexOf("::busy_reply:") !== -1) {
            console.log("busy reply", event);
            result_editor.setValue("scheme engine is busy");
        }
        if (text.indexOf("::invalid_request:") !== -1) {
            console.log("invalid request", event);
            result_editor.setValue("request was not recognized:\n" + text);
        }
    }

</script>